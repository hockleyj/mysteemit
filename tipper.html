<html>

<head>
    <script src="https://cdn.steemjs.com/lib/latest/steem.min.js"></script>
    <style>
        body {
            font-family: ubuntu;
            font-size: 13px;
        }

        label {
            font-family: ubuntu;
            font-size: 13px;
        }

        input[type='text'],
        input[type='password'],
        input[type='number'],
        textarea {
            font-family: ubuntu;
            font-size: 13px;
            width: 300px;
            resize: none;
        }

        input[type='button'] {
            font-family: ubuntu;
            font-size: 13px;
            font-weight: bold;
        }

        div.error {
            font-family: ubuntu;
            font-size: 13px;
            color: red;
        }

        div.output,
        span.output,
        div,
        span {
            font-family: ubuntu;
            font-size: 13px;
        }
    </style>

    <script>
        Date.prototype.getUTCTime = function() {
            return this.getTime() + (this.getTimezoneOffset() * 60000);
        };

        function appendHTML(html, reset = false) {
            var div = document.createElement("div");
            div.innerHTML = html;

            if (reset) {
                document.getElementById('result').innerHTML = "";
            }

            document.getElementById('result').appendChild(div);
            window.scrollTo(0, document.body.scrollHeight);
        }

        var followers = new Array();
        var followers_ = new Array();
        var followers__ = new Array();
        var lastOne = '0';
        var chunk = 1000;
        var myFee = 0.001 //Per Transaction
        var totalFee = 0; //Total Fee
        var feeFlag = false;

        function checkAccountName(flag = false) {
            disableTransfer();
            var accountName = document.getElementById('accountName').value;
            steem.api.getAccounts([accountName], function(err, result) {
                if (result.length == 0) {
                    var errorMessage = 'Not available!';
                    document.getElementById('accountName_err').innerHTML = errorMessage;
                    return false;
                } else {
                    if (parseFloat(result[0].sbd_balance) < totalFee) {
                        var errorMessage = 'Not enough SBD!';
                        document.getElementById('accountName_err').innerHTML = errorMessage;
                        document.getElementById('transfer').disabled = true;
                        return false;
                    } else {
                        document.getElementById('accountName_err').innerHTML = '';
                        if (flag && totalFee > myFee) {
                            disableTransfer(false);
                        }
                        return true;
                    }
                }
            });
        }

        function checkTipAmount() {
            disableTransfer();
            var tipAmount = document.getElementById('tipAmount').value;
            var errorMessage = '';
            document.getElementById('tipAmount_err').innerHTML = errorMessage;
            var reg = /^\d*[\.]\d*$/;
            var tip = parseFloat(tipAmount);
            if (!tipAmount.match(reg) || tip < 0.001 || tipAmount.split('.')[1].length > 3) {
                var errorMessage = 'Not valid!';
                document.getElementById('tipAmount_err').innerHTML = errorMessage;
                return false;
            } else {
                return true;
            }
        }

        function validate() {
            checkAccountName();
            checkActiveKey();
            checkTipAmount();
            checkInactiveHours();
			checkTipMessage();

            var elements = document.getElementsByClassName('error');
            for (e = 0; e < elements.length; e++) {
                if (elements[e].innerHTML != "") {
                    return false;
                }
            }

            return true;
        }

        function calculateFee() {
            totalFee = myFee;
            if (validate()) {
                appendHTML("", true);
                disableAll(true);
                startLoading();
                var accountName = document.getElementById('accountName').value;
                getFollowers(accountName);
            }
        }
		
		function checkTipMessage() {
			var tipMessage = document.getElementById('tipMessage').value;
            var errorMessage = '';
            document.getElementById('tipMessage_err').innerHTML = errorMessage;
			if (tipMessage == null || tipMessage == '') {
                var errorMessage = 'Type something!';
                document.getElementById('tipMessage_err').innerHTML = errorMessage;
                return false;
            } else {
                return true;
			}
		}

        function checkInactiveHours() {
            disableTransfer();
            var inactiveHours = document.getElementById('inactiveHours').value;
            var errorMessage = '';
            document.getElementById('inactiveHours_err').innerHTML = errorMessage;
            var reg = /^[\d]\d*$/;
            var hours = parseInt(inactiveHours);
            if (!inactiveHours.match(reg) || hours < 1) {
                var errorMessage = 'Not valid!';
                document.getElementById('inactiveHours_err').innerHTML = errorMessage;
                return false;
            } else {
                return true;
            }
        }

        function checkActiveKey() {
            disableTransfer();
            var activeKey = document.getElementById('activeKey').value;
            var errorMessage = '';
            document.getElementById('activeKey_err').innerHTML = errorMessage;

            if (!steem.auth.isWif(activeKey)) {
                var errorMessage = 'False key!';
                document.getElementById('activeKey_err').innerHTML = errorMessage;
                return false;
            } else {
                var accountName = document.getElementById('accountName').value;
                steem.api.getAccounts([accountName], function(err, result) {
                    if (result.length > 0) {
                        var activeKey = document.getElementById('activeKey').value;
                        var publicKey = result[0].active.key_auths[0][0];
                        if (!steem.auth.wifIsValid(activeKey, publicKey)) {
                            var errorMessage = 'Wrong key!';
                            document.getElementById('activeKey_err').innerHTML = errorMessage;
                            return false;
                        }
                    } else {
                        return true;
                    }
                });
            }
        }

        function addFollowers(following, fresult) {
            if (followers.length > 1) {
                fresult.shift();
            }
            followers = followers.concat(fresult);
            lastOne = followers[followers.length - 1].follower;
            if (fresult.length != 0) {
                queryFollowers(following);
            } else {
                for (f_ in followers) {
                    followers_.push(followers[f_].follower);
                }

                removeinactiveHours();
            }
        }

        function queryFollowers(following) {
            steem.api.getFollowers(following, lastOne, 'blog', chunk, function(err, result) {
                addFollowers(following, result);
            });
        }

        function getFollowers(following) {
            followers = new Array();
            followers_ = new Array();
            followers__ = new Array();
            lastOne = '0';
            queryFollowers(following);
        }

        function removeinactiveHours() {
            //Remove Dead Followers
            steem.api.getAccounts(followers_, function(err, result) {
                for (r in result) {
                    var follower = result[r];
                    var lastActive = new Date(follower.last_post);
                    var today = new Date();
                    var hours = document.getElementById('inactiveHours').value;
                    if ((today.getUTCTime() - lastActive.getTime()) / (1000 * 60 * 60) <= hours) {
                        followers__.push(follower.name);
                    }
                }

                oninactiveHoursRemoved();
            });
        }

        function oninactiveHoursRemoved() {
            var tipAmount = document.getElementById('tipAmount').value;
            var tip = parseFloat(parseFloat(tipAmount).toFixed(3));
            totalFee = followers__.length * (myFee + tip);
            checkAccountName(true);

            appendHTML('<b>Active Followers: </b>' + followers__.length, true);
            appendHTML('<b>Total Fee: </b>' + totalFee.toFixed(3) + ' SBD');
            stopLoading();
            disableAll(false);
        }

        function disableAll(flag = true) {
            document.getElementById('accountName').disabled = flag;
            document.getElementById('activeKey').disabled = flag;
            document.getElementById('tipAmount').disabled = flag;
            document.getElementById('inactiveHours').disabled = flag;
            document.getElementById('tipMessage').disabled = flag;
            document.getElementById('calculateFee').disabled = flag;

            if (flag) {
                document.getElementById('transfer').disabled = flag;
            }
        }

        function disableTransfer(flag = true) {
            document.getElementById('transfer').disabled = flag;
        }

        var barId = 0;

        function startLoading(milliseconds = 500) {
            document.getElementById('status').innerHTML = 'PLEASE WAIT';
            barId = window.setInterval(loadBar, milliseconds);
        }

        function stopLoading(message = '') {
            window.clearInterval(barId);
            document.getElementById('status').innerHTML = message;
            document.getElementById('bar').innerHTML = '';
        }

        function loadBar() {
            var barValue = document.getElementById('bar').innerHTML;
            if (barValue.length == 3) {
                barValue = '';
            } else {
                barValue += '.';
            }

            document.getElementById('bar').innerHTML = barValue;
        }

        function transferTheTips() {
            var myFee_ = (followers__.length * myFee).toFixed(3) + " SBD";
            var confirm_ = confirm("This is a clientside application, which means if you close this window, the application will stop without completeing all the transactions. The first transaction will be 
				   's fee which is " + myFee_ + ". All transfers are non-refundable. Are you sure you want to continue?");

            if (confirm_) {
                disableAll();
                startLoading();

                var activeKey = document.getElementById('activeKey').value;
                var accountName = document.getElementById('accountName').value;

                appendHTML("<BR />");
                steem.broadcast.transfer(activeKey, accountName, 'msg768', myFee_, "BTA-FEE", function(err, result) {
                    if (err == null) {
                        appendHTML("Transfered " + myFee_ + " To @msg768.");
                        var activeKey = document.getElementById('activeKey').value;
                        var accountName = document.getElementById('accountName').value;
                        var tipMessage = document.getElementById('tipMessage').value;
                        var tipAmount = document.getElementById('tipAmount').value;
                        tipAmount = parseFloat(tipAmount).toFixed(3) + " SBD";
                        bulkTransfer(accountName, activeKey, tipAmount, tipMessage);
                    } else {
                        appendHTML("Transfering " + myFee_ + " To @msg768 Failed.");
                        disableAll(false);
                        console.log(err);
                        stopLoading();
                    }
                });
            }
        }

        function bulkTransfer(accountName, activeKey, tipAmount, tipMessage, index = 0) {
            if (index == followers__.length) {
                appendHTML("<BR />");
                appendHTML("ALL DONE! :]");
                stopLoading();
                return;
            } else {
                steem.broadcast.transfer(activeKey, accountName, followers__[index], tipAmount, tipMessage, function(err, result) {
                    if (err == null) {
                        appendHTML("Transfered " + tipAmount + " To @" + followers__[index] + ".");
                    } else {
                        followers__.push(followers__[index]);
                        appendHTML("Transfering " + tipAmount + " To @" + followers__[index] + " Failed. Will try this transaction again a bit later.");
                        console.log(err);
                    }
                    bulkTransfer(accountName, activeKey, tipAmount, tipMessage, index + 1);
                });
            }
        }
    </script>
</head>

<body>
    <div align='center'><a target="_blank" href="https://steemit.com/steemit/@msg768/new-steem-tool-tip-message-your-active-followers-in-their-wallet" style="">TIP/MESSAGE YOUR ACTIVE FOLLOWERS IN THEIR WALLET</a></div>
    <br />
    <div align='center'>
        <h2>FEE: 0.001 SBD PER TRANSACTION
            <h2>
    </div>
    <table align='center'>
        <tr>
            <td colspan='3'>
                <hr />
            </td>
        </tr>
        <tr>
            <td style='width: 100px'><label for='accountName'>Account Name: </label></td>
            <td><input type='text' placeholder='Your Account Name' id='accountName' onchange='checkAccountName();' /></td>
            <td style='width: 180px'>
                <div class='error' id='accountName_err'></div>
            </td>
        </tr>
        <tr>
            <td><label for='activeKey'>Active Key: </label></td>
            <td><input type='password' placeholder='Your Active Key' id='activeKey' onchange='checkActiveKey();' /></td>
            <td>
                <div class='error' id='activeKey_err'></div>
            </td>
        </tr>
        <tr>
            <td><label for='tipAmount'>SBD Amount: </label></td>
            <td>
                <input type='number' min='0.001' value='0.001' id='tipAmount' onchange='checkTipAmount();' />
            </td>
            <td>
                <div class='error' id='tipAmount_err'></div>
            </td>
        </tr>
        <tr>
            <td><label for='inactiveHours'>Inactive Hours: </label></td>
            <td>
                <input type='number' min='1' placeholder='Acceptable Number of Inactive Hours' id='inactiveHours' onchange='checkInactiveHours();' />
            </td>
            <td>
                <div class='error' id='inactiveHours_err'></div>
            </td>
        </tr>
        <tr>
            <td><label for='tipMessage'>Tip Message: </label></td>
            <td><textarea rows='5' placeholder="Tip Message/Transfer Memo&#10;Example: Celebrating 1000+ Followers! <3" id='tipMessage' onchange='checkTipMessage();'></textarea></td>
            <td>
                <div class='error' id='tipMessage_err'></div>
            </td>
        </tr>
        <tr>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td colspan='2'>
                <input type='button' id='calculateFee' value='Calculate Fee' onclick='calculateFee();' />
                <input type='button' id='transfer' value='Tip/Transfer' onclick='transferTheTips();' disabled='disabled' /> &nbsp;
                <span id='status'></span><span id='bar'></span>
            </td>
        </tr>
        <tr>
            <td colspan='3'>
                <hr />
            </td>
        </tr>
        <tr>
            <td colspan='3'>
                <div class='output' id='result'></div>
            </td>
        </tr>
    </table>

</body>

</html>
